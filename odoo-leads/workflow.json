{
  "name": "CRM Odoo Leads + Postgres",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        -336,
        0
      ],
      "id": "e7b0fdbf-3348-48c3-a8c5-6ca6d4a693cc",
      "name": "Ejecuci√≥n cada 15 minutos"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "processia_leads",
          "mode": "list",
          "cachedResultName": "processia_leads"
        },
        "where": {
          "values": [
            {
              "column": "synced_to_odoo",
              "value": "false"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "created_at",
              "direction": "DESC"
            }
          ]
        },
        "options": {
          "largeNumbersOutput": "text"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -128,
        0
      ],
      "id": "f433ecf1-359d-4508-856d-7576633825b5",
      "name": "Selecciona filas nuevas",
      "credentials": {
        "postgres": {
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        128,
        0
      ],
      "id": "a6e22e27-b8fa-445a-9bab-d0b04e89c60a",
      "name": "Bucle"
    },
    {
      "parameters": {
        "jsCode": "// Obtener datos del lead desde PostgreSQL\nconst lead = $input.item.json;\n\n// 1. CONSTRUIR NOMBRE DEL LEAD\n// Formato: \"Nombre - Empresa\" o solo \"Nombre\" si no hay empresa\nconst leadName = lead.empresa \n  ? `${lead.nombre} - ${lead.empresa}` \n  : lead.nombre;\n\n// 2. MAPEAR LEAD QUALITY A PRIORITY DE ODOO\n// Odoo usa prioridad num√©rica: 0=muy baja, 1=baja, 2=normal, 3=alta\nconst priorityMap = {\n  'hot': '3',    // Alta prioridad (üî•)\n  'warm': '2',   // Media prioridad (‚ö†Ô∏è)\n  'cold': '1'    // Baja prioridad (‚ùÑÔ∏è)\n};\n\n// 3. LIMPIAR Y VALIDAR TEL√âFONO\nlet phoneClean = '';\nif (lead.telefono) {\n  // Quitar espacios, guiones, par√©ntesis\n  phoneClean = lead.telefono.toString().replace(/[\\s\\-\\(\\)]/g, '');\n  \n  // Si no empieza con +593 (Ecuador), agregarlo\n  if (phoneClean && !phoneClean.startsWith('+593') && !phoneClean.startsWith('593')) {\n    phoneClean = '+593' + phoneClean;\n  } else if (phoneClean.startsWith('593')) {\n    phoneClean = '+' + phoneClean;\n  }\n}\n\n// 4. PREPARAR DESCRIPCI√ìN ENRIQUECIDA\nconst description = `\n${lead.mensaje || 'Sin mensaje'}\n\n---\nüìä INFORMACI√ìN ADICIONAL:\n‚Ä¢ Lead Score: ${lead.lead_score}/100\n‚Ä¢ Calidad: ${lead.lead_quality.toUpperCase()}\n‚Ä¢ Fuente: ${lead.source || 'processia.online'}\n‚Ä¢ Fecha captura: ${lead.created_at}\n‚Ä¢ ID de seguimiento: ${lead.lead_id}\n\n${lead.metadata ? 'üìç Metadata: ' + JSON.stringify(lead.metadata, null, 2) : ''}\n`.trim();\n\n// 5. CONSTRUIR OBJETO PARA ODOO\nconst odooLead = {\n  // Campos obligatorios\n  name: leadName,\n  \n  // Informaci√≥n de contacto\n  contact_name: lead.nombre,\n  email_from: lead.email,\n  phone: phoneClean,\n  \n  // Informaci√≥n de empresa\n  partner_name: lead.empresa || '',\n  \n  // Descripci√≥n completa\n  description: description,\n  \n  // Tipo: 'lead' (si tu Odoo lo soporta) o 'opportunity'\n  type: 'opportunity',\n  \n  // Prioridad seg√∫n clasificaci√≥n\n  priority: priorityMap[lead.lead_quality] || '1',\n  \n  // CAMPOS PERSONALIZADOS (solo si los creaste en Odoo)\n  // Si no los creaste, comenta estas l√≠neas:\n  // x_lead_id: lead.lead_id,\n  // x_lead_score: lead.lead_score,\n  // x_source_web: lead.source || 'processia.online'\n};\n\n// 6. RETORNAR DATOS PREPARADOS\nreturn {\n  json: {\n    // Datos para crear en Odoo\n    odooLead: odooLead,\n    \n    // Datos para actualizar PostgreSQL despu√©s\n    postgresId: lead.id,\n    leadId: lead.lead_id,\n    \n    // Datos originales (por si se necesitan)\n    originalData: lead\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        64
      ],
      "id": "d64f594b-1e90-489a-a091-70eb1bf1ade9",
      "name": "JS: Construcci√≥n Lead"
    },
    {
      "parameters": {
        "resource": "opportunity",
        "opportunityName": "={{ $json.odooLead.name }}",
        "additionalFields": {
          "email_from": "={{ $json.odooLead.email_from }}",
          "phone": "={{ $json.odooLead.phone }}",
          "priority": "={{ $json.odooLead.priority }}"
        }
      },
      "type": "n8n-nodes-base.odoo",
      "typeVersion": 1,
      "position": [
        544,
        64
      ],
      "id": "dfe25b24-5165-4c94-a72f-58171f2c1dd3",
      "name": "Creaci√≥n Lead en Odoo",
      "credentials": {
        "odooApi": {
          "name": "Odoo account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "ee78c608-3c0f-49bb-8a1d-3314020c8162",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        720,
        64
      ],
      "id": "8306c5c7-3030-4efd-b243-c47c11f75676",
      "name": "If: ID v√°lido"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE processia_leads\nSET \n  synced_to_odoo = true,\n  updated_at = NOW()\nWHERE id = {{ $('JS: Construcci√≥n Lead').item.json.postgresId }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        928,
        48
      ],
      "id": "9de92b88-7b07-46a5-bfd2-550ada888b18",
      "name": "Actualizaci√≥n par√°metros",
      "credentials": {
        "postgres": {
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Regreso",
      "typeVersion": 1,
      "position": [
        1104,
        48
      ],
      "id": "1efbe7bb-5395-42b5-b381-8fc8cd222cf5"
    },
    {
      "parameters": {
        "jsCode": "// Logging de error\nconst leadData = $('JS: Construcci√≥n Lead').item.json;\nconst odooError = $('Creaci√≥n Lead en Odoo').item.json;\n\nconst errorLog = {\n  timestamp: new Date().toISOString(),\n  lead_id: leadData.leadId,\n  postgres_id: leadData.postgresId,\n  nombre: leadData.originalData.nombre,\n  email: leadData.originalData.email,\n  error_message: odooError.error || 'Unknown error',\n  error_details: JSON.stringify(odooError)\n};\n\nconsole.error('‚ùå Error creating opportunity:', errorLog);\n\n// Este lead NO se marca como sincronizado\n// Se reintentar√° en 15 minutos\nreturn { json: { ...errorLog, shouldRetry: true } };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        944,
        272
      ],
      "id": "89aa7243-23d0-4ee6-8fe6-365bb099cbc3",
      "name": "JS: Gesti√≥n de errores"
    }
  ],
  "pinData": {},
  "connections": {
    "Ejecuci√≥n cada 15 minutos": {
      "main": [
        [
          {
            "node": "Selecciona filas nuevas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Selecciona filas nuevas": {
      "main": [
        [
          {
            "node": "Bucle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bucle": {
      "main": [
        [],
        [
          {
            "node": "JS: Construcci√≥n Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JS: Construcci√≥n Lead": {
      "main": [
        [
          {
            "node": "Creaci√≥n Lead en Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Creaci√≥n Lead en Odoo": {
      "main": [
        [
          {
            "node": "If: ID v√°lido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: ID v√°lido": {
      "main": [
        [
          {
            "node": "Actualizaci√≥n par√°metros",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "JS: Gesti√≥n de errores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizaci√≥n par√°metros": {
      "main": [
        [
          {
            "node": "Regreso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Regreso": {
      "main": [
        [
          {
            "node": "Bucle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JS: Gesti√≥n de errores": {
      "main": [
        [
          {
            "node": "Regreso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Guayaquil",
    "executionTimeout": -1,
  },
  "tags": []
}